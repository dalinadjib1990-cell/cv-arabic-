<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dali Note - دفتر التنقيط الرقمي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a237e;
            --primary-light: #534bae;
            --primary-dark: #000051;
            --secondary: #d4af37;
            --secondary-light: #ffecb3;
            --secondary-dark: #a07828;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196f3;
            --light: #f8f9fa;
            --dark: #212121;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* الوضع الليلي */
        .dark-mode {
            --primary: #0d1b2a;
            --primary-light: #1b263b;
            --primary-dark: #050a14;
            --secondary: #ffd700;
            --secondary-light: #333;
            --secondary-dark: #cca300;
            --light: #121212;
            --dark: #e0e0e0;
            --gray: #b0b0b0;
            --gray-light: #222;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            transition: var(--transition);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* الهيدر */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--secondary) 0%, #ffeb3b 100%);
        }

        .app-title {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .app-title i {
            color: var(--secondary);
            font-size: 3rem;
        }

        .blessing {
            font-size: 1.5rem;
            color: var(--secondary);
            margin-bottom: 15px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to right, #d4af37, #ffd700, #d4af37);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* الأزرار */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #388e3c;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        /* البطاقات */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .dark-mode .card {
            background-color: var(--primary-light);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dark-mode .card-title {
            color: var(--secondary);
        }

        /* إدارة الأقسام */
        .sections-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .section-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            border-left: 5px solid var(--primary);
            transition: var(--transition);
        }

        .dark-mode .section-card {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
        }

        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .section-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .dark-mode .section-name {
            color: var(--secondary);
        }

        .section-info {
            color: var(--gray);
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        /* نموذج إضافة قسم */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .dark-mode .modal-content {
            background-color: var(--primary-light);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .dark-mode .modal-title {
            color: var(--secondary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .dark-mode .form-label {
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--light);
            color: var(--dark);
        }

        .dark-mode .form-control {
            background-color: var(--gray-light);
            color: var(--dark);
            border-color: var(--gray);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.2);
        }

        /* جدول التلاميذ */
        .students-table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .students-table thead {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .students-table th {
            padding: 15px;
            text-align: center;
            font-weight: 700;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .students-table th:last-child {
            border-right: none;
        }

        .students-table tbody tr {
            transition: var(--transition);
        }

        .students-table tbody tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .dark-mode .students-table tbody tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .students-table tbody tr:hover {
            background-color: rgba(26, 35, 126, 0.05);
        }

        .dark-mode .students-table tbody tr:hover {
            background-color: rgba(212, 175, 55, 0.1);
        }

        .students-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid var(--gray-light);
        }

        .student-name-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            background-color: transparent;
            color: var(--dark);
            text-align: center;
        }

        .dark-mode .student-name-input {
            color: var(--dark);
        }

        /* أزرار + و - */
        .score-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .score-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .score-btn.plus {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .score-btn.plus:hover {
            background-color: var(--success);
            color: white;
        }

        .score-btn.minus {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }

        .score-btn.minus:hover {
            background-color: var(--danger);
            color: white;
        }

        .score-value {
            min-width: 40px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* المدخلات العادية */
        .score-input {
            width: 70px;
            padding: 8px;
            border: 1px solid var(--gray-light);
            border-radius: 4px;
            text-align: center;
            background-color: transparent;
            color: var(--dark);
            font-weight: 600;
        }

        .dark-mode .score-input {
            color: var(--dark);
        }

        /* العمليات */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        /* معدل وملاحظات */
        .average-cell {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .notes-cell {
            max-width: 200px;
            font-size: 0.9rem;
            padding: 8px;
        }

        .auto-note {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .note-weak {
            background-color: rgba(244, 67, 54, 0.15);
            color: #c62828;
        }

        .note-average {
            background-color: rgba(255, 152, 0, 0.15);
            color: #ef6c00;
        }

        .note-good {
            background-color: rgba(76, 175, 80, 0.15);
            color: #2e7d32;
        }

        .note-very-good {
            background-color: rgba(33, 150, 243, 0.15);
            color: #1565c0;
        }

        .note-excellent {
            background-color: rgba(156, 39, 176, 0.15);
            color: #6a1b9a;
        }

        /* لوحة التحكم */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .dark-mode .control-panel {
            background-color: var(--primary-light);
        }

        .toggle-dark-mode {
            margin-left: auto;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray);
            transition: var(--transition);
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--secondary);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        /* معاينة وتصدير */
        .export-preview {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            display: none;
        }

        .export-preview.active {
            display: block;
        }

        .dark-mode .export-preview {
            background-color: var(--primary-light);
        }

        .preview-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--secondary);
        }

        .institution-name {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .teacher-info {
            font-size: 1.2rem;
            color: var(--gray);
            margin-bottom: 5px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .preview-table th {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
        }

        .preview-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid var(--gray-light);
        }

        .preview-table tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .template-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .template-card {
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .template-card.active {
            border-color: var(--secondary);
            background-color: rgba(212, 175, 55, 0.05);
        }

        .template-name {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .template-colors {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .color-1 { background-color: #1a237e; }
        .color-2 { background-color: #d4af37; }
        .color-3 { background-color: #4caf50; }
        .color-4 { background-color: #2196f3; }
        .color-5 { background-color: #9c27b0; }

        /* التنبيهات */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-success {
            background-color: rgba(76, 175, 80, 0.15);
            border-left: 5px solid var(--success);
            color: #2e7d32;
        }

        .alert-info {
            background-color: rgba(33, 150, 243, 0.15);
            border-left: 5px solid var(--info);
            color: #1565c0;
        }

        .alert-warning {
            background-color: rgba(255, 152, 0, 0.15);
            border-left: 5px solid var(--warning);
            color: #ef6c00;
        }

        /* الطباعة */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .export-preview, .export-preview * {
                visibility: visible;
            }
            
            .export-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
            }
            
            .no-print {
                display: none !important;
            }
        }

        /* تجاوبية */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-title {
                font-size: 2rem;
            }
            
            .blessing {
                font-size: 1.2rem;
            }
            
            .control-panel {
                flex-direction: column;
            }
            
            .toggle-dark-mode {
                margin-left: 0;
            }
            
            .card-title {
                font-size: 1.3rem;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .students-table th,
            .students-table td {
                padding: 8px;
            }
            
            .score-btn {
                width: 30px;
                height: 30px;
                font-size: 1rem;
            }
            
            .score-input {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- الهيدر -->
        <header class="header">
            <h1 class="app-title">
                <i class="fas fa-book-open"></i>
                AI Dali Note
            </h1>
            <div class="blessing">اللهم صلِّ وسلم على سيدنا محمد</div>
            <div class="teacher-info" id="teacherInfo">
                <div>المؤسسة: <strong>ثانوية الإمام مالك</strong></div>
                <div>الأستاذ: <strong>عمر بن عبد الكريم</strong></div>
                <div>المادة: <strong>الرياضيات</strong></div>
                <div>السنة الدراسية: <strong>2023/2024</strong></div>
                <div>الأقسام المسندة: <strong id="assignedSections">لا توجد أقسام</strong></div>
            </div>
        </header>

        <!-- لوحة التحكم -->
        <div class="control-panel">
            <button class="btn btn-primary" id="addSectionBtn">
                <i class="fas fa-plus"></i> إضافة قسم
            </button>
            <button class="btn btn-secondary" id="viewStudentsBtn">
                <i class="fas fa-users"></i> عرض التلاميذ
            </button>
            <button class="btn btn-success" id="calculateAveragesBtn">
                <i class="fas fa-calculator"></i> حساب المعدلات
            </button>
            <button class="btn btn-primary" id="previewExportBtn">
                <i class="fas fa-eye"></i> معاينة وتصدير
            </button>
            <button class="btn btn-secondary" id="saveDataBtn">
                <i class="fas fa-save"></i> حفظ البيانات
            </button>
            <div class="toggle-dark-mode">
                <span style="margin-left: 10px;">الوضع الليلي</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- رسالة ترحيب -->
        <div class="alert alert-info" id="welcomeAlert">
            <i class="fas fa-info-circle"></i>
            <div>مرحبًا بك في دفتر التنقيط الرقمي. ابدأ بإضافة قسم جديد ثم إضافة التلاميذ وتقييمهم.</div>
            <button class="btn btn-sm btn-secondary" onclick="hideWelcomeAlert()">إخفاء</button>
        </div>

        <!-- قسم إدارة الأقسام -->
        <div class="card no-print" id="sectionsCard">
            <h2 class="card-title">
                <i class="fas fa-list"></i>
                إدارة الأقسام
            </h2>
            <div class="sections-container" id="sectionsContainer">
                <!-- سيتم إضافة الأقسام هنا ديناميكيًا -->
                <div class="no-sections" id="noSectionsMessage" style="text-align: center; padding: 40px; color: var(--gray); grid-column: 1/-1;">
                    <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    <h3>لا توجد أقسام</h3>
                    <p>إبدأ بإضافة قسم جديد لتتمكن من إضافة التلاميذ وتقييمهم</p>
                    <button class="btn btn-primary mt-3" id="addFirstSectionBtn">
                        <i class="fas fa-plus"></i> إضافة أول قسم
                    </button>
                </div>
            </div>
        </div>

        <!-- قسم جدول التلاميذ -->
        <div class="card no-print" id="studentsCard" style="display: none;">
            <h2 class="card-title">
                <i class="fas fa-users"></i>
                جدول التلاميذ - <span id="currentSectionName">غير محدد</span>
            </h2>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <div>يمكنك استخدام أزرار (+) و (-) لتعديل نقاط التقويم المستمر. المعدل يحسب تلقائيًا: [(الفرض + التقويم المستمر)/2 + (الاختبار × 2)] ÷ 3</div>
            </div>
            <div class="students-table-container">
                <table class="students-table" id="studentsTable">
                    <thead>
                        <tr>
                            <th width="50">م</th>
                            <th width="200">الاسم</th>
                            <th width="200">اللقب</th>
                            <th width="150">التقويم المستمر</th>
                            <th width="120">الفرض</th>
                            <th width="120">الاختبار</th>
                            <th width="120">المعدل</th>
                            <th width="250">الملاحظات التلقائية</th>
                            <th width="150">العمليات</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <!-- سيتم إضافة التلاميذ هنا ديناميكيًا -->
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-primary" id="addStudentBtn">
                    <i class="fas fa-user-plus"></i> إضافة تلميذ
                </button>
                <button class="btn btn-secondary" id="backToSectionsBtn">
                    <i class="fas fa-arrow-right"></i> العودة إلى الأقسام
                </button>
            </div>
        </div>

        <!-- قسم المعاينة والتصدير -->
        <div class="export-preview no-print" id="exportPreview">
            <h2 class="card-title">
                <i class="fas fa-file-export"></i>
                معاينة وتصدير دفتر النقاط
            </h2>
            
            <!-- اختيار القالب -->
            <div class="form-group">
                <label class="form-label">اختر قالب التصدير:</label>
                <div class="template-options">
                    <div class="template-card active" data-template="classic">
                        <div class="template-colors">
                            <div class="color-dot color-1"></div>
                            <div class="color-dot color-2"></div>
                        </div>
                        <div class="template-name">كلاسيكي</div>
                        <div class="template-desc">أزرق وذهبي</div>
                    </div>
                    <div class="template-card" data-template="modern">
                        <div class="template-colors">
                            <div class="color-dot color-3"></div>
                            <div class="color-dot color-4"></div>
                        </div>
                        <div class="template-name">حديث</div>
                        <div class="template-desc">أخضر وأزرق</div>
                    </div>
                    <div class="template-card" data-template="elegant">
                        <div class="template-colors">
                            <div class="color-dot color-5"></div>
                            <div class="color-dot color-2"></div>
                        </div>
                        <div class="template-name">أنيق</div>
                        <div class="template-desc">بنفسجي وذهبي</div>
                    </div>
                </div>
            </div>
            
            <!-- معاينة التصدير -->
            <div id="previewContent">
                <!-- سيتم عرض المعاينة هنا ديناميكيًا -->
            </div>
            
            <!-- أزرار التصدير -->
            <div class="text-center mt-4">
                <button class="btn btn-primary" id="printBtn">
                    <i class="fas fa-print"></i> طباعة
                </button>
                <button class="btn btn-success" id="exportPdfBtn">
                    <i class="fas fa-file-pdf"></i> تصدير PDF
                </button>
                <button class="btn btn-secondary" id="exportWordBtn">
                    <i class="fas fa-file-word"></i> تصدير Word
                </button>
                <button class="btn btn-danger" id="closePreviewBtn">
                    <i class="fas fa-times"></i> إغلاق المعاينة
                </button>
            </div>
        </div>

        <!-- رسالة حفظ -->
        <div class="alert alert-success" id="saveAlert" style="display: none; position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 1000;">
            <i class="fas fa-check-circle"></i>
            <div>تم حفظ البيانات بنجاح!</div>
        </div>
    </div>

    <!-- نموذج إضافة قسم -->
    <div class="modal" id="addSectionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-plus"></i> إضافة قسم جديد
                </h3>
                <button class="close-modal" id="closeSectionModal">&times;</button>
            </div>
            <form id="addSectionForm">
                <div class="form-group">
                    <label class="form-label">اسم القسم</label>
                    <input type="text" class="form-control" id="sectionName" placeholder="مثال: 4م1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">المادة</label>
                    <select class="form-control" id="sectionSubject" required>
                        <option value="">اختر المادة</option>
                        <option value="الرياضيات">الرياضيات</option>
                        <option value="الفيزياء">الفيزياء</option>
                        <option value="العلوم">العلوم</option>
                        <option value="اللغة العربية">اللغة العربية</option>
                        <option value="اللغة الفرنسية">اللغة الفرنسية</option>
                        <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                        <option value="التاريخ والجغرافيا">التاريخ والجغرافيا</option>
                        <option value="التربية الإسلامية">التربية الإسلامية</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">السنة الدراسية</label>
                    <input type="text" class="form-control" id="sectionYear" value="2023/2024" required>
                </div>
                <div class="form-group">
                    <label class="form-label">عدد التلاميذ (اختياري)</label>
                    <input type="number" class="form-control" id="sectionStudentsCount" value="40" min="1" max="60">
                    <small class="form-text" style="color: var(--gray);">يمكنك تغيير هذا العدد لاحقًا</small>
                </div>
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> إضافة القسم
                    </button>
                    <button type="button" class="btn btn-danger" id="cancelSectionModal">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- نموذج إضافة تلميذ -->
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-plus"></i> إضافة تلميذ جديد
                </h3>
                <button class="close-modal" id="closeStudentModal">&times;</button>
            </div>
            <form id="addStudentForm">
                <div class="form-group">
                    <label class="form-label">الاسم</label>
                    <input type="text" class="form-control" id="studentFirstName" placeholder="الاسم" required>
                </div>
                <div class="form-group">
                    <label class="form-label">اللقب</label>
                    <input type="text" class="form-control" id="studentLastName" placeholder="اللقب" required>
                </div>
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> إضافة التلميذ
                    </button>
                    <button type="button" class="btn btn-danger" id="cancelStudentModal">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // البيانات والتخزين
        let sections = JSON.parse(localStorage.getItem('aiDaliNoteSections')) || [];
        let currentSectionId = null;
        let darkMode = localStorage.getItem('aiDaliNoteDarkMode') === 'true';
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تطبيق الوضع الليلي
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }
            
            // عرض الأقسام إن وجدت
            renderSections();
            updateAssignedSections();
            
            // إضافة مستمعي الأحداث
            setupEventListeners();
            
            // عرض رسالة الترحيب إذا كانت أول زيارة
            if (!localStorage.getItem('aiDaliNoteWelcomeShown')) {
                document.getElementById('welcomeAlert').style.display = 'flex';
            }
        });
        
        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // زر إضافة قسم
            document.getElementById('addSectionBtn').addEventListener('click', () => {
                document.getElementById('addSectionModal').classList.add('active');
            });
            
            document.getElementById('addFirstSectionBtn').addEventListener('click', () => {
                document.getElementById('addSectionModal').classList.add('active');
            });
            
            // زر إغلاق نموذج إضافة قسم
            document.getElementById('closeSectionModal').addEventListener('click', () => {
                document.getElementById('addSectionModal').classList.remove('active');
            });
            
            document.getElementById('cancelSectionModal').addEventListener('click', () => {
                document.getElementById('addSectionModal').classList.remove('active');
            });
            
            // إرسال نموذج إضافة قسم
            document.getElementById('addSectionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewSection();
            });
            
            // الوضع الليلي
            document.getElementById('darkModeToggle').addEventListener('change', function() {
                darkMode = this.checked;
                document.body.classList.toggle('dark-mode', darkMode);
                localStorage.setItem('aiDaliNoteDarkMode', darkMode);
            });
            
            // زر عرض التلاميذ
            document.getElementById('viewStudentsBtn').addEventListener('click', function() {
                if (sections.length === 0) {
                    alert('يجب إضافة قسم أولاً');
                    document.getElementById('addSectionModal').classList.add('active');
                    return;
                }
                
                // عرض القسم الأول إذا لم يكن هناك قسم محدد
                if (currentSectionId === null) {
                    currentSectionId = sections[0].id;
                }
                
                showStudentsTable();
            });
            
            // زر العودة إلى الأقسام
            document.getElementById('backToSectionsBtn').addEventListener('click', function() {
                document.getElementById('studentsCard').style.display = 'none';
                document.getElementById('sectionsCard').style.display = 'block';
                document.getElementById('exportPreview').classList.remove('active');
            });
            
            // زر إضافة تلميذ
            document.getElementById('addStudentBtn').addEventListener('click', function() {
                document.getElementById('addStudentModal').classList.add('active');
            });
            
            // زر إغلاق نموذج إضافة تلميذ
            document.getElementById('closeStudentModal').addEventListener('click', () => {
                document.getElementById('addStudentModal').classList.remove('active');
            });
            
            document.getElementById('cancelStudentModal').addEventListener('click', () => {
                document.getElementById('addStudentModal').classList.remove('active');
            });
            
            // إرسال نموذج إضافة تلميذ
            document.getElementById('addStudentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addNewStudent();
            });
            
            // زر حساب المعدلات
            document.getElementById('calculateAveragesBtn').addEventListener('click', calculateAllAverages);
            
            // زر معاينة وتصدير
            document.getElementById('previewExportBtn').addEventListener('click', showExportPreview);
            
            // زر إغلاق المعاينة
            document.getElementById('closePreviewBtn').addEventListener('click', function() {
                document.getElementById('exportPreview').classList.remove('active');
                document.getElementById('sectionsCard').style.display = 'block';
            });
            
            // زر حفظ البيانات
            document.getElementById('saveDataBtn').addEventListener('click', saveAllData);
            
            // اختيار القوالب
            document.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    renderPreview();
                });
            });
            
            // زر الطباعة
            document.getElementById('printBtn').addEventListener('click', function() {
                window.print();
            });
            
            // زر تصدير PDF (محاكاة)
            document.getElementById('exportPdfBtn').addEventListener('click', function() {
                alert('سيتم تصدير الملف كـ PDF. في التطبيق الكامل، سيتم استخدام مكتبة مثل jsPDF لإنشاء ملف PDF حقيقي.');
                // هنا يمكن إضافة كود تصدير PDF باستخدام jsPDF
            });
            
            // زر تصدير Word (محاكاة)
            document.getElementById('exportWordBtn').addEventListener('click', function() {
                alert('سيتم تصدير الملف كـ Word. في التطبيق الكامل، سيتم استخدام مكتبة لإنشاء ملف Word.');
                // هنا يمكن إضافة كود تصدير Word
            });
            
            // حفظ تلقائي عند التعديل
            setupAutoSave();
        }
        
        // إخفاء رسالة الترحيب
        function hideWelcomeAlert() {
            document.getElementById('welcomeAlert').style.display = 'none';
            localStorage.setItem('aiDaliNoteWelcomeShown', 'true');
        }
        
        // إضافة قسم جديد
        function addNewSection() {
            const sectionName = document.getElementById('sectionName').value;
            const sectionSubject = document.getElementById('sectionSubject').value;
            const sectionYear = document.getElementById('sectionYear').value;
            const studentsCount = parseInt(document.getElementById('sectionStudentsCount').value) || 40;
            
            const newSection = {
                id: Date.now().toString(),
                name: sectionName,
                subject: sectionSubject,
                year: sectionYear,
                students: [],
                createdAt: new Date().toISOString()
            };
            
            // إضافة تلاميذ افتراضيين
            for (let i = 1; i <= studentsCount; i++) {
                newSection.students.push({
                    id: i,
                    firstName: `تلميذ ${i}`,
                    lastName: `لقب ${i}`,
                    continuousEvaluation: 10,
                    assignment: 0,
                    exam: 0,
                    average: 0,
                    notes: ''
                });
            }
            
            sections.push(newSection);
            saveSectionsToStorage();
            renderSections();
            updateAssignedSections();
            
            // إغلاق النموذج وإعادة تعيين الحقول
            document.getElementById('addSectionModal').classList.remove('active');
            document.getElementById('addSectionForm').reset();
            document.getElementById('sectionYear').value = '2023/2024';
            document.getElementById('sectionStudentsCount').value = 40;
            
            // عرض رسالة نجاح
            showSaveAlert();
        }
        
        // عرض الأقسام
        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            
            if (sections.length === 0) {
                document.getElementById('noSectionsMessage').style.display = 'block';
                return;
            }
            
            document.getElementById('noSectionsMessage').style.display = 'none';
            
            container.innerHTML = '';
            
            sections.forEach(section => {
                const sectionCard = document.createElement('div');
                sectionCard.className = 'section-card';
                sectionCard.innerHTML = `
                    <div class="section-name">${section.name}</div>
                    <div class="section-info">
                        <div>المادة: ${section.subject}</div>
                        <div>السنة: ${section.year}</div>
                        <div>عدد التلاميذ: ${section.students.length}</div>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-sm btn-primary view-section-btn" data-id="${section.id}">
                            <i class="fas fa-eye"></i> عرض التلاميذ
                        </button>
                        <button class="btn btn-sm btn-secondary edit-section-btn" data-id="${section.id}">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-sm btn-danger delete-section-btn" data-id="${section.id}">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </div>
                `;
                
                container.appendChild(sectionCard);
            });
            
            // إضافة مستمعي الأحداث للأزرار الديناميكية
            document.querySelectorAll('.view-section-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentSectionId = this.getAttribute('data-id');
                    showStudentsTable();
                });
            });
            
            document.querySelectorAll('.edit-section-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-id');
                    editSection(sectionId);
                });
            });
            
            document.querySelectorAll('.delete-section-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-id');
                    deleteSection(sectionId);
                });
            });
        }
        
        // تحديث الأقسام المسندة في الهيدر
        function updateAssignedSections() {
            if (sections.length === 0) {
                document.getElementById('assignedSections').textContent = 'لا توجد أقسام';
                return;
            }
            
            const sectionNames = sections.map(s => s.name).join('، ');
            document.getElementById('assignedSections').textContent = sectionNames;
        }
        
        // عرض جدول التلاميذ
        function showStudentsTable() {
            const section = sections.find(s => s.id === currentSectionId);
            if (!section) return;
            
            document.getElementById('currentSectionName').textContent = section.name;
            document.getElementById('sectionsCard').style.display = 'none';
            document.getElementById('studentsCard').style.display = 'block';
            document.getElementById('exportPreview').classList.remove('active');
            
            renderStudentsTable(section);
        }
        
        // عرض جدول التلاميذ
        function renderStudentsTable(section) {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';
            
            section.students.forEach((student, index) => {
                const average = calculateStudentAverage(student);
                const notes = getAutoNotes(average);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <input type="text" class="student-name-input" value="${student.firstName}" 
                               data-id="${student.id}" data-field="firstName">
                    </td>
                    <td>
                        <input type="text" class="student-name-input" value="${student.lastName}" 
                               data-id="${student.id}" data-field="lastName">
                    </td>
                    <td>
                        <div class="score-control">
                            <button class="score-btn minus" data-id="${student.id}" data-type="continuousEvaluation">-</button>
                            <span class="score-value" id="ce-${student.id}">${student.continuousEvaluation}</span>
                            <button class="score-btn plus" data-id="${student.id}" data-type="continuousEvaluation">+</button>
                        </div>
                    </td>
                    <td>
                        <input type="number" class="score-input" value="${student.assignment}" min="0" max="20" step="0.5"
                               data-id="${student.id}" data-field="assignment">
                    </td>
                    <td>
                        <input type="number" class="score-input" value="${student.exam}" min="0" max="20" step="0.5"
                               data-id="${student.id}" data-field="exam">
                    </td>
                    <td class="average-cell" id="avg-${student.id}">${average.toFixed(2)}</td>
                    <td class="notes-cell">
                        <span class="auto-note ${getNoteClass(average)}">${notes}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-success calculate-btn" data-id="${student.id}">
                                <i class="fas fa-calculator"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-student-btn" data-id="${student.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // إضافة مستمعي الأحداث للعناصر الديناميكية
            setupStudentTableEvents();
            
            // حساب المعدلات التلقائية
            calculateAllAverages();
        }
        
        // إعداد مستمعي الأحداث لجدول التلاميذ
        function setupStudentTableEvents() {
            // أزرار + و - للتقويم المستمر
            document.querySelectorAll('.score-btn.plus').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = parseInt(this.getAttribute('data-id'));
                    const type = this.getAttribute('data-type');
                    updateContinuousEvaluation(studentId, 1);
                });
            });
            
            document.querySelectorAll('.score-btn.minus').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = parseInt(this.getAttribute('data-id'));
                    const type = this.getAttribute('data-type');
                    updateContinuousEvaluation(studentId, -1);
                });
            });
            
            // تحديث أسماء التلاميذ
            document.querySelectorAll('.student-name-input').forEach(input => {
                input.addEventListener('change', function() {
                    const studentId = parseInt(this.getAttribute('data-id'));
                    const field = this.getAttribute('data-field');
                    const value = this.value;
                    updateStudentField(studentId, field, value);
                });
            });
            
            // تحديث الفرض والاختبار
            document.querySelectorAll('.score-input').forEach(input => {
                input.addEventListener('change', function() {
                    const studentId = parseInt(this.getAttribute('data-id'));
                    const field = this.getAttribute('data-field');
                    const value = parseFloat(this.value) || 0;
                    updateStudentField(studentId, field, value);
                });
            });
            
            // أزرار الحذف
            document.querySelectorAll('.delete-student-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = parseInt(this.getAttribute('data-id'));
                    deleteStudent(studentId);
                });
            });
            
            // أزرار حساب المعدل الفردي
            document.querySelectorAll('.calculate-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = parseInt(this.getAttribute('data-id'));
                    calculateStudentAverageById(studentId);
                });
            });
        }
        
        // تحديث التقويم المستمر
        function updateContinuousEvaluation(studentId, change) {
            const section = sections.find(s => s.id === currentSectionId);
            if (!section) return;
            
            const student = section.students.find(s => s.id === studentId);
            if (!student) return;
            
            student.continuousEvaluation = Math.max(0, Math.min(20, student.continuousEvaluation + change));
            
            // تحديث العرض
            document.getElementById(`ce-${studentId}`).textContent = student.continuousEvaluation;
            
            // إعادة حساب المعدل
            calculateStudentAverageById(studentId);
            
            // حفظ التغييرات
            saveSectionsToStorage();
        }
        
        // تحديث حقل التلميذ
        function updateStudentField(studentId, field, value) {
            const section = sections.find(s => s.id === currentSectionId);
            if (!section) return;
            
            const student = section.students.find(s => s.id === studentId);
            if (!student) return;
            
            student[field] = value;
            
            // إعادة حساب المعدل إذا كان الحقل مرتبطًا بالنقاط
            if (field === 'assignment' || field === 'exam') {
                calculateStudentAverageById(studentId);
            }
            
            // حفظ التغييرات
            saveSectionsToStorage();
        }
        
        // حساب معدل تلميذ
        function calculateStudentAverage(student) {
            const ce = student.continuousEvaluation || 0;
            const assignment = student.assignment || 0;
            const exam = student.exam || 0;
            
            // الصيغة: [(الفرض + التقويم المستمر)/2 + (الاختبار × 2)] ÷ 3
            const average = ((assignment + ce) / 2 + (exam * 2)) / 3;
            return Math.min(20, Math.max(0, average));
        }
        
        // حساب معدل تلميذ معين وعرضه
        function calculateStudentAverageById(studentId) {
            const section = sections.find(s => s.id === currentSectionId);
            if (!section) return;
            
            const student = section.students.find(s => s.id === studentId);
            if (!student) return;
            
            const average = calculateStudentAverage(student);
            student.average = average;
            
            // تحديث العرض
            document.getElementById(`avg-${studentId}`).textContent = average.toFixed(2);
            
            // تحديث الملاحظات
            const notes = getAutoNotes(average);
            const noteClass = getNoteClass(average);
            const notesCell = document.querySelector(`#avg-${studentId}`).parentNode.nextElementSibling;
            notesCell.innerHTML = `<span class="auto-note ${noteClass}">${notes}</span>`;
            
            // حفظ التغييرات
            saveSectionsToStorage();
            
            return average;
        }
        
        // حساب جميع المعدلات
        function calculateAllAverages() {
            const section = sections.find(s => s.id === currentSectionId);
            if (!section) return;
            
            section.students.forEach(student => {
                const average = calculateStudentAverage(student);
                student.average = average;
            });
            
            // إعادة عرض الجدول
            renderStudentsTable(section);
            
            // عرض رسالة نجاح
            showSaveAlert('تم حساب جميع المعدلات بنجاح!');
        }
        
        // الحصول على الملاحظات التلقائية حسب المعدل
        function getAutoNotes(average) {
            if (average < 5) return 'ضعيف جداً - دون المستوى';
            if (average < 10) return 'ضعيف - عليك بالمزيد من الجدية';
            if (average < 13) return 'حسن - فوق الوسط';
            if (average < 15) return 'جيد - عمل جيد';
            if (average < 18) return 'جيد جداً - وأصْلُو';
            return 'ممتاز - تلميذ مميز - أحسنت يا عبقري';
        }
        
        // الحصول على فئة الملاحظة حسب المعدل
        function getNoteClass(average) {
            if (average < 5) return 'note-weak';
            if (average < 10) return 'note-weak';
            if (average < 13) return 'note-average';
            if (average < 15) return 'note-good';
            if (average < 18) return 'note-very-good';
            return 'note-excellent';
        }
        
        // إضافة تلميذ جديد
        function addNewStudent() {
            const section = sections.find(s => s.id === currentSectionId);
            if (!section) return;
            
            const firstName = document.getElementById('studentFirstName').value;
            const lastName = document.getElementById('studentLastName').value;
            
            const newStudent = {
                id: section.students.length > 0 ? Math.max(...section.students.map(s => s.id)) + 1 : 1,
                firstName: firstName,
                lastName: lastName,
                continuousEvaluation: 10,
                assignment: 0,
                exam: 0,
                average: 0,
                notes: ''
            };
            
            section.students.push(newStudent);
            saveSectionsToStorage();
            
            // إغلاق النموذج وإعادة تعيين الحقول
            document.getElementById('addStudentModal').classList.remove('active');
            document.getElementById('addStudentForm').reset();
            
            // إعادة عرض الجدول
            renderStudentsTable(section);
            
            // عرض رسالة نجاح
            showSaveAlert('تم إضافة التلميذ بنجاح!');
        }
        
        // حذف تلميذ
        function deleteStudent(studentId) {
            if (!confirm('هل أنت متأكد من حذف هذا التلميذ؟')) return;
            
            const section = sections.find(s => s.id === currentSectionId);
            if (!section) return;
            
            const studentIndex = section.students.findIndex(s => s.id === studentId);
            if (studentIndex === -1) return;
            
            section.students.splice(studentIndex, 1);
            saveSectionsToStorage();
            
            // إعادة عرض الجدول
            renderStudentsTable(section);
            
            // عرض رسالة نجاح
            showSaveAlert('تم حذف التلميذ بنجاح!');
        }
        
        // تعديل قسم
        function editSection(sectionId) {
            // في التطبيق الكامل، يمكن فتح نموذج لتعديل القسم
            alert('ميزة تعديل القسم قيد التطوير. في الإصدار الكامل، سيتم فتح نموذج لتعديل معلومات القسم.');
        }
        
        // حذف قسم
        function deleteSection(sectionId) {
            if (!confirm('هل أنت متأكد من حذف هذا القسم؟ سيتم حذف جميع بيانات التلاميذ فيه.')) return;
            
            const sectionIndex = sections.findIndex(s => s.id === sectionId);
            if (sectionIndex === -1) return;
            
            sections.splice(sectionIndex, 1);
            saveSectionsToStorage();
            
            // إعادة عرض الأقسام
            renderSections();
            updateAssignedSections();
            
            // إذا كان القسم المحذوف هو المعروض حالياً
            if (currentSectionId === sectionId) {
                document.getElementById('studentsCard').style.display = 'none';
                document.getElementById('sectionsCard').style.display = 'block';
                currentSectionId = null;
            }
            
            // عرض رسالة نجاح
            showSaveAlert('تم حذف القسم بنجاح!');
        }
        
        // عرض معاينة التصدير
        function showExportPreview() {
            if (sections.length === 0) {
                alert('يجب إضافة قسم أولاً');
                document.getElementById('addSectionModal').classList.add('active');
                return;
            }
            
            document.getElementById('sectionsCard').style.display = 'none';
            document.getElementById('studentsCard').style.display = 'none';
            document.getElementById('exportPreview').classList.add('active');
            
            renderPreview();
        }
        
        // عرض المعاينة
        function renderPreview() {
            const section = currentSectionId ? 
                sections.find(s => s.id === currentSectionId) : 
                sections[0];
                
            if (!section) return;
            
            const template = document.querySelector('.template-card.active').getAttribute('data-template');
            
            // حساب المعدلات إذا لم تكن محسوبة
            section.students.forEach(student => {
                if (!student.average || student.average === 0) {
                    student.average = calculateStudentAverage(student);
                }
            });
            
            let previewHTML = `
                <div class="preview-header">
                    <div class="institution-name">ثانوية الإمام مالك</div>
                    <div class="teacher-info">دفتر نقاط المادة: ${section.subject}</div>
                    <div class="teacher-info">الأستاذ: عمر بن عبد الكريم</div>
                    <div class="teacher-info">السنة الدراسية: ${section.year}</div>
                    <div class="teacher-info">القسم: ${section.name}</div>
                </div>
                
                <table class="preview-table">
                    <thead>
                        <tr>
                            <th>م</th>
                            <th>الاسم واللقب</th>
                            <th>التقويم المستمر</th>
                            <th>الفرض</th>
                            <th>الاختبار</th>
                            <th>المعدل</th>
                            <th>الملاحظات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            section.students.forEach((student, index) => {
                const notes = getAutoNotes(student.average);
                const noteClass = getNoteClass(student.average);
                
                previewHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${student.continuousEvaluation}</td>
                        <td>${student.assignment}</td>
                        <td>${student.exam}</td>
                        <td><strong>${student.average.toFixed(2)}</strong></td>
                        <td><span class="auto-note ${noteClass}">${notes}</span></td>
                    </tr>
                `;
            });
            
            previewHTML += `
                    </tbody>
                </table>
                
                <div style="margin-top: 50px; text-align: left;">
                    <div style="margin-bottom: 30px;">
                        <div>توقيع الأستاذ:</div>
                        <div style="margin-top: 50px; border-top: 1px solid #000; width: 200px;"></div>
                    </div>
                    <div>
                        <div>ختم المؤسسة:</div>
                        <div style="margin-top: 30px; width: 150px; height: 150px; border: 2px dashed #000; display: flex; align-items: center; justify-content: center;">
                            <span>ختم المؤسسة</span>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 50px; font-size: 0.9rem; color: #666;">
                    <div>تم الإنشاء بواسطة تطبيق AI Dali Note - دفتر التنقيط الرقمي</div>
                    <div>التاريخ: ${new Date().toLocaleDateString('ar-EG')}</div>
                </div>
            `;
            
            document.getElementById('previewContent').innerHTML = previewHTML;
        }
        
        // حفظ جميع البيانات
        function saveAllData() {
            saveSectionsToStorage();
            showSaveAlert('تم حفظ جميع البيانات بنجاح!');
        }
        
        // حفظ الأقسام في التخزين المحلي
        function saveSectionsToStorage() {
            localStorage.setItem('aiDaliNoteSections', JSON.stringify(sections));
        }
        
        // إعداد الحفظ التلقائي
        function setupAutoSave() {
            // حفظ تلقائي عند مغادرة الصفحة
            window.addEventListener('beforeunload', function() {
                saveSectionsToStorage();
            });
            
            // حفظ تلقائي كل 30 ثانية
            setInterval(function() {
                saveSectionsToStorage();
            }, 30000);
        }
        
        // عرض رسالة الحفظ
        function showSaveAlert(message = 'تم حفظ البيانات بنجاح!') {
            const alert = document.getElementById('saveAlert');
            alert.querySelector('div').textContent = message;
            alert.style.display = 'flex';
            
            // إخفاء الرسالة بعد 3 ثوان
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }
        
        // تصدير البيانات كملف
        function exportData() {
            const dataStr = JSON.stringify(sections, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `ai-dali-note-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
    </script>
</body>
</html>
